<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon KPN - Particles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700;900&display=swap');

        :root {
            --rock: #ef4444;
            --paper: #3b82f6;
            --scissors: #22c55e;
            --glow-rock: 0 0 30px #ef4444;
            --glow-paper: 0 0 30px #3b82f6;
            --glow-scissors: 0 0 30px #22c55e;
            --glass: rgba(15, 15, 25, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: #030308;
            color: #eee;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* ANIMATED BACKGROUND */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(ellipse at 20% 20%, rgba(100, 0, 150, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 100, 200, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 150, 100, 0.1) 0%, transparent 60%);
            animation: nebulaPulse 8s ease-in-out infinite alternate;
        }

        @keyframes nebulaPulse {
            0% {
                opacity: 0.6;
                filter: hue-rotate(0deg);
            }

            100% {
                opacity: 1;
                filter: hue-rotate(30deg);
            }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* PREMIUM GLASSMORPHISM SCREENS */
        .ui-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: radial-gradient(circle at center, rgba(10, 10, 20, 0.95) 0%, rgba(5, 5, 10, 0.98) 100%);
        }

        .ui-screen.active {
            opacity: 1;
            pointer-events: auto;
        }

        .panel {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 420px;
            text-align: center;
            animation: panelFloat 3s ease-in-out infinite;
        }

        @keyframes panelFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* ANIMATED TITLE */
        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 4.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00ff88, #00d4ff, #8b5cf6, #ff006e);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: titleGlow 4s ease-in-out infinite;
            text-shadow: 0 0 60px rgba(0, 255, 200, 0.3);
            letter-spacing: 4px;
        }

        @keyframes titleGlow {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .inp {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
            padding: 14px 18px;
            color: white;
            border-radius: 12px;
            margin-bottom: 12px;
            outline: none;
            transition: 0.3s;
            font-family: inherit;
            font-size: 1.1rem;
        }

        .inp:focus {
            border-color: #0ff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .btn {
            width: 100%;
            padding: 14px;
            font-weight: 700;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            letter-spacing: 2px;
            font-size: 1.1rem;
            margin-top: 8px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: 0.5s;
        }

        .btn:hover::before {
            transform: translateX(100%);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #000;
            box-shadow: 0 5px 30px rgba(0, 255, 200, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px rgba(0, 255, 200, 0.5);
        }

        .btn-sec {
            background: transparent;
            color: #666;
            border: 1px solid #333;
        }

        .btn-sec:hover {
            color: #fff;
            border-color: #666;
        }

        /* ROOM LIST */
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid transparent;
        }

        .room-item:hover {
            background: rgba(0, 255, 200, 0.1);
            border-color: rgba(0, 255, 200, 0.3);
            transform: translateX(5px);
        }

        /* CLASS SELECTION CARDS */
        .class-card {
            width: 100px;
            height: 140px;
            background: var(--glass);
            border: 2px solid #333;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0 12px;
            position: relative;
            overflow: hidden;
        }

        .class-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 120%, currentColor, transparent 70%);
            opacity: 0;
            transition: 0.3s;
        }

        .class-card:hover {
            transform: translateY(-10px) scale(1.05);
        }

        .class-card:hover::before {
            opacity: 0.2;
        }

        .class-card.sel {
            border-color: #fff;
            transform: scale(1.15);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.3);
        }

        #c-rock {
            color: var(--rock);
        }

        #c-rock.sel {
            box-shadow: var(--glow-rock);
            border-color: var(--rock);
        }

        #c-paper {
            color: var(--paper);
        }

        #c-paper.sel {
            box-shadow: var(--glow-paper);
            border-color: var(--paper);
        }

        #c-scissors {
            color: var(--scissors);
        }

        #c-scissors.sel {
            box-shadow: var(--glow-scissors);
            border-color: var(--scissors);
        }

        /* HUD */
        #hud {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: none;
        }

        .hud-bar-c {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #bar-hp-c {
            bottom: 65px;
        }

        #bar-xp-c {
            bottom: 48px;
            height: 6px;
            width: 260px;
        }

        .fill {
            height: 100%;
            transition: width 0.3s ease-out;
        }

        #bar-hp {
            background: linear-gradient(90deg, #ff3366, #ff6b6b);
            box-shadow: 0 0 15px rgba(255, 100, 100, 0.5);
        }

        #bar-xp {
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        /* COOLDOWN BUTTONS */
        .touch-zone {
            position: absolute;
            bottom: 40px;
            width: 140px;
            height: 140px;
            pointer-events: auto;
        }

        #touch-l {
            left: 40px;
        }

        #touch-r {
            position: absolute;
            bottom: 180px;
            right: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .skill-btn,
        .cd-icon {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: rgba(20, 20, 30, 0.8);
            border: 3px solid #444;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: white;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .skill-btn.ready,
        .cd-icon.ready {
            border-color: #0f0;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.6), inset 0 0 15px rgba(0, 255, 0, 0.2);
            animation: readyPulse 1s ease-in-out infinite;
        }

        @keyframes readyPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        #cooldowns-pc {
            position: absolute;
            bottom: 180px;
            right: 20px;
            display: flex;
            gap: 15px;
            pointer-events: none;
        }

        .cd-fill {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            transition: 0.1s;
        }

        @media (pointer: fine) {
            .touch-zone {
                display: none !important;
            }
        }

        @media (pointer: coarse) {
            #cooldowns-pc {
                display: none !important;
            }
        }

        /* ============ MOBILE UI/UX IMPROVEMENTS ============ */
        @media (max-width: 768px) {

            /* Login Screen */
            .game-title {
                font-size: 2.8rem !important;
                letter-spacing: 2px;
            }

            .panel {
                padding: 1.5rem;
                margin: 0 15px;
                max-width: calc(100% - 30px);
            }

            .btn {
                padding: 16px;
                font-size: 1rem;
            }

            .inp {
                padding: 14px;
                font-size: 1rem;
            }

            /* Class Selection */
            .class-card {
                width: 85px;
                height: 120px;
                margin: 0 8px;
            }

            .class-card .text-5xl {
                font-size: 2.5rem;
            }

            /* HUD Elements */
            .hud-bar-c {
                width: 200px !important;
            }

            #bar-xp-c {
                width: 160px !important;
            }

            #score-disp {
                font-size: 1.5rem !important;
            }

            #xp-text {
                font-size: 9px !important;
            }

            /* Leaderboard - hide on mobile */
            #leaderboard-panel {
                display: none !important;
            }

            /* KDA Display */
            #kda-disp {
                font-size: 0.9rem;
            }

            /* Chat - smaller on mobile */
            #chat-ui {
                width: 200px;
                height: 120px;
                bottom: 10px;
                left: 10px;
            }

            #chat-msgs {
                font-size: 10px;
            }

            /* Minimap - smaller */
            #minimap-c {
                width: 100px !important;
                height: 100px !important;
                bottom: 15px;
                right: 15px;
            }

            /* Skill buttons - larger for touch */
            #touch-r {
                bottom: 130px;
                right: 15px;
                gap: 12px;
            }

            .skill-btn {
                width: 70px !important;
                height: 70px !important;
                font-size: 28px !important;
            }

            /* Touch joystick zone */
            #touch-l {
                bottom: 30px;
                left: 20px;
                width: 120px;
                height: 120px;
            }

            /* Perk Selection - Mobile Optimized */
            #perk-ui {
                top: 5%;
                padding: 0 10px;
            }

            #perk-ui h2 {
                font-size: 1.8rem !important;
                margin-bottom: 10px !important;
            }

            #perk-ui p {
                font-size: 1rem !important;
                margin-bottom: 15px !important;
            }

            .perk-opt {
                width: 140px !important;
                padding: 15px 12px !important;
                margin: 8px !important;
                border-radius: 14px;
            }

            .perk-icon {
                font-size: 2rem !important;
            }

            .perk-opt .text-lg {
                font-size: 0.9rem !important;
            }

            .perk-opt .text-xs {
                font-size: 0.65rem !important;
            }

            /* Victory/Defeat */
            .victory-text {
                font-size: 2.5rem !important;
            }

            #victory-stats {
                font-size: 1rem !important;
            }

            /* Kill Feed - smaller */
            #kill-feed {
                width: 200px;
                top: 50px;
                right: 10px;
            }

            .kill-item {
                padding: 6px 10px;
                font-size: 10px;
            }

            /* Storm warning */
            #warn-sing {
                font-size: 1rem !important;
            }
        }

        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            .game-title {
                font-size: 2.2rem !important;
            }

            .panel {
                padding: 1.2rem;
            }

            .class-card {
                width: 70px;
                height: 100px;
                margin: 0 5px;
            }

            .class-card .text-5xl {
                font-size: 2rem;
            }

            .class-card .text-lg {
                font-size: 0.8rem;
            }

            .hud-bar-c {
                width: 160px !important;
            }

            #bar-xp-c {
                width: 130px !important;
            }

            #minimap-c {
                width: 80px !important;
                height: 80px !important;
            }

            .skill-btn {
                width: 60px !important;
                height: 60px !important;
            }

            #touch-r {
                bottom: 110px;
                right: 10px;
            }

            .perk-opt {
                width: 120px !important;
                padding: 12px 10px !important;
            }

            #chat-ui {
                display: none;
            }

            /* Hide chat on very small screens */
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            #perk-ui {
                top: 2%;
            }

            #perk-ui h2 {
                font-size: 1.5rem !important;
                margin-bottom: 5px !important;
            }

            .perk-opt {
                width: 130px !important;
                padding: 10px !important;
                margin: 5px !important;
            }

            .perk-icon {
                font-size: 1.5rem !important;
                margin-bottom: 5px !important;
            }

            .hud-bar-c {
                bottom: 40px !important;
            }

            #bar-xp-c {
                bottom: 28px !important;
            }

            #xp-text {
                bottom: 15px !important;
            }
        }

        /* LEVEL UP / PERK SELECTION - REDESIGNED */
        #perk-ui {
            position: absolute;
            top: 10%;
            width: 100%;
            text-align: center;
            pointer-events: auto;
            display: none;
            z-index: 50;
        }

        #perk-ui h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            background: linear-gradient(135deg, #ffd700, #ff6b6b, #ffd700);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: levelUpGlow 1s ease-in-out infinite alternate;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin-bottom: 30px;
        }

        @keyframes levelUpGlow {
            0% {
                background-position: 0% 50%;
                filter: brightness(1);
            }

            100% {
                background-position: 100% 50%;
                filter: brightness(1.3);
            }
        }

        .perk-opt {
            display: inline-block;
            background: linear-gradient(180deg, rgba(20, 20, 40, 0.95) 0%, rgba(10, 10, 25, 0.98) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(0, 255, 255, 0.4);
            padding: 25px 20px;
            margin: 15px;
            width: 180px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .perk-opt::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            /* FIX: Allow clicks to pass through */
        }

        .perk-opt:hover::before {
            opacity: 1;
        }

        .perk-opt:hover {
            transform: translateY(-15px) scale(1.08);
            border-color: #0ff;
            box-shadow: 0 25px 60px rgba(0, 255, 255, 0.3), 0 0 40px rgba(0, 255, 255, 0.2);
        }

        .perk-opt:nth-child(1) {
            border-color: rgba(255, 100, 100, 0.5);
        }

        .perk-opt:nth-child(1):hover {
            border-color: #ff6b6b;
            box-shadow: 0 25px 60px rgba(255, 100, 100, 0.3);
        }

        .perk-opt:nth-child(2) {
            border-color: rgba(100, 200, 255, 0.5);
        }

        .perk-opt:nth-child(2):hover {
            border-color: #60a5fa;
            box-shadow: 0 25px 60px rgba(100, 200, 255, 0.3);
        }

        .perk-opt:nth-child(3) {
            border-color: rgba(100, 255, 100, 0.5);
        }

        .perk-opt:nth-child(3):hover {
            border-color: #4ade80;
            box-shadow: 0 25px 60px rgba(100, 255, 100, 0.3);
        }

        .perk-opt:nth-child(4) {
            border-color: rgba(255, 200, 100, 0.5);
        }

        .perk-opt:nth-child(4):hover {
            border-color: #fbbf24;
            box-shadow: 0 25px 60px rgba(255, 200, 100, 0.3);
        }

        .perk-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }

        /* MINIMAP */
        #minimap-c {
            position: absolute;
            z-index: 5;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #333;
            border-radius: 50%;
            overflow: hidden;
            pointer-events: none;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* CHAT */
        #chat-ui {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 320px;
            height: 200px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
        }

        #chat-msgs {
            flex: 1;
            overflow-y: auto;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            font-size: 13px;
            padding: 5px;
        }

        #chat-in {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            outline: none;
            display: none;
        }

        #chat-in:focus {
            border-color: #0ff;
        }

        #perf {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 11px;
            color: #0f0;
            font-family: monospace;
            text-shadow: 0 0 5px #0f0;
        }

        /* KILL FEED */
        #kill-feed {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 280px;
            pointer-events: none;
        }

        .kill-item {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 8px 14px;
            margin-bottom: 6px;
            border-radius: 8px;
            font-size: 12px;
            border-left: 3px solid #ff4444;
            animation: killSlide 0.4s ease-out, killFade 3s ease-out forwards;
        }

        @keyframes killSlide {
            from {
                transform: translateX(100px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes killFade {

            0%,
            70% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        /* TOASTS */
        .toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 50, 50, 0.9), rgba(200, 0, 0, 0.9));
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            animation: toastAnim 3s forwards;
            box-shadow: 0 5px 30px rgba(255, 0, 0, 0.4);
        }

        @keyframes toastAnim {
            0% {
                opacity: 0;
                transform: translate(-50%, 20px) scale(0.8);
            }

            10% {
                opacity: 1;
                transform: translate(-50%, 0) scale(1);
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
        }

        /* STREAK INDICATOR */
        .streak-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 30px #ffd700, 0 0 60px #ff6600;
            animation: streakPop 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes streakPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }

            20% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        /* VICTORY/DEFEAT OVERLAY */
        #game-over-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            animation: overlayFade 0.5s ease-out;
        }

        @keyframes overlayFade {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .victory-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 20px;
        }

        .victory-text.win {
            color: #ffd700;
            text-shadow: 0 0 50px #ffd700;
        }

        .victory-text.lose {
            color: #666;
        }

        /* FULLSCREEN BUTTON */
        #btn-fs {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 22px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        #btn-fs:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #0ff;
            transform: scale(1.1);
        }

        /* SCREEN SHAKE */
        .shake {
            animation: screenShake 0.3s ease-out;
        }

        @keyframes screenShake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            20% {
                transform: translate(-5px, 3px);
            }

            40% {
                transform: translate(5px, -3px);
            }

            60% {
                transform: translate(-3px, 5px);
            }

            80% {
                transform: translate(3px, -5px);
            }
        }

        /* LEADERBOARD */
        #leaderboard-panel {
            position: absolute;
            top: 60px;
            right: 180px;
            width: 220px;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            font-size: 11px;
            z-index: 10;
        }
    </style>
</head>

<body>
    <div id="toasts"></div>
    <div id="kill-feed"></div>
    <button id="btn-fs" onclick="toggleFullScreen()">‚õ∂</button>

    <!-- GAME OVER OVERLAY -->
    <div id="game-over-overlay">
        <div class="victory-text" id="victory-title">VICTORY</div>
        <div id="victory-stats" style="color:#888; font-size:1.2rem;"></div>
        <button class="btn btn-primary" style="width:200px; margin-top:30px;"
            onclick="app.closeOverlay()">KONTYNUUJ</button>
    </div>

    <div id="s-login" class="ui-screen active">
        <h1 class="game-title mb-2">NEON KPN</h1>
        <p class="text-gray-400 mb-8 tracking-widest text-sm" style="font-family: Orbitron;">ULTIMATE EDITION</p>
        <div class="panel">
            <input id="nick" class="inp" placeholder="‚ö° Tw√≥j Nick" maxlength="15">
            <div id="stats-prev" class="text-xs text-gray-500 mt-2 mb-4"
                style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">≈Åadowanie statystyk...</div>
            <button class="btn btn-primary" onclick="app.connect()">üéÆ GRAJ</button>
            <button class="btn btn-sec" onclick="app.screen('s-manual')">üìñ JAK GRAƒÜ?</button>
        </div>
    </div>

    <div id="s-manual" class="ui-screen">
        <div class="panel" style="max-width:800px; text-align:left;">
            <h1 class="text-3xl font-black mb-4 text-center"
                style="font-family:Orbitron; background: linear-gradient(90deg, #0ff, #f0f); -webkit-background-clip:text; color:transparent;">
                JAK GRAƒÜ?</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <h3 class="text-xl font-bold text-yellow-400 mb-3">‚å®Ô∏è STEROWANIE</h3>
                    <ul class="list-disc pl-5 text-gray-300 space-y-2">
                        <li><b class="text-white">WSAD / Joystick:</b> Poruszanie siƒô</li>
                        <li><b class="text-white">SPACJA / ‚ö°:</b> Dash (Sprint)</li>
                        <li><b class="text-white">E / ‚òÖ:</b> Umiejƒôtno≈õƒá Specjalna</li>
                        <li><b class="text-white">Enter:</b> Czat</li>
                        <li><b class="text-white">1-4:</b> Emotki</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-blue-400 mb-3">üéØ ZASADY KPN</h3>
                    <ul class="list-disc pl-5 text-gray-300 space-y-2">
                        <li><span class="text-red-500">ü™® KAMIE≈É</span> bije <span class="text-green-500">‚úÇÔ∏è
                                NO≈ªYCE</span></li>
                        <li><span class="text-green-500">‚úÇÔ∏è NO≈ªYCE</span> bijƒÖ <span class="text-blue-500">üìÑ
                                PAPIER</span></li>
                        <li><span class="text-blue-500">üìÑ PAPIER</span> bije <span class="text-red-500">ü™®
                                KAMIE≈É</span></li>
                        <li>Unikaj <span class="text-purple-500">‚ö° BURZY</span> (czerwona strefa)!</li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 p-4 rounded-lg"
                style="background:linear-gradient(135deg, rgba(0,255,200,0.1), rgba(0,100,255,0.1)); border:1px solid rgba(0,255,200,0.2);">
                <h3 class="text-lg font-bold text-cyan-400 mb-2">‚ú® ULTIMATE EDITION</h3>
                <p class="text-gray-400 text-sm">Ulepszona grafika, efekty czƒÖsteczkowe, animacje i wiele wiƒôcej!</p>
            </div>
            <button class="btn btn-primary mt-6" onclick="app.screen('s-login')">ROZUMIEM, JAZDA! üöÄ</button>
        </div>
    </div>

    <div id="s-list" class="ui-screen">
        <h2 class="text-3xl font-bold mb-6" style="font-family:Orbitron;">üåê SERWERY</h2>
        <div class="panel" style="max-width: 500px;">
            <div id="rooms" class="text-left mb-4 overflow-y-auto" style="max-height: 300px;"></div>
            <button class="btn btn-primary" onclick="app.screen('s-create')">‚ûï NOWY POK√ìJ</button>
            <button class="btn btn-sec" onclick="app.screen('s-login')">‚¨Ö POWR√ìT</button>
        </div>
    </div>

    <div id="s-create" class="ui-screen">
        <div class="panel">
            <h2 class="text-2xl font-bold mb-4" style="font-family:Orbitron;">üè† NOWY POK√ìJ</h2>
            <input id="c-name" class="inp" placeholder="Nazwa pokoju">
            <select id="c-mode" class="inp" style="background:#111;">
                <option value="play">‚öîÔ∏è STANDARD</option>
                <option value="koth">üëë KING OF THE HILL</option>
            </select>
            <input id="c-pass" class="inp" placeholder="üîí Has≈Ço (opcjonalne)">
            <button class="btn btn-primary" onclick="app.createRoom()">STW√ìRZ</button>
            <button class="btn btn-sec" onclick="app.screen('s-list')">ANULUJ</button>
        </div>
    </div>

    <div id="s-lobby" class="ui-screen">
        <div class="panel" style="max-width: 650px;">
            <h2 class="text-xl font-bold mb-4 text-gray-400">WYBIERZ KLASƒò</h2>
            <div class="flex justify-center mb-8" id="class-sel">
                <div class="class-card" onclick="app.setType('rock')" id="c-rock">
                    <div class="text-5xl mb-2">ü™®</div>
                    <div class="text-red-400 font-bold text-lg">TANK</div>
                    <div class="text-xs text-gray-500 mt-1">200 HP | Thorns</div>
                </div>
                <div class="class-card" onclick="app.setType('paper')" id="c-paper">
                    <div class="text-5xl mb-2">üìÑ</div>
                    <div class="text-blue-400 font-bold text-lg">SPEED</div>
                    <div class="text-xs text-gray-500 mt-1">140 HP | Regen</div>
                </div>
                <div class="class-card" onclick="app.setType('scissors')" id="c-scissors">
                    <div class="text-5xl mb-2">‚úÇÔ∏è</div>
                    <div class="text-green-400 font-bold text-lg">DPS</div>
                    <div class="text-xs text-gray-500 mt-1">150 HP | Crit</div>
                </div>
            </div>

            <div class="w-full mb-4">
                <h3 class="text-gray-400 text-sm font-bold mb-2 text-left" id="roster-header">üë• GRACZE W POKOJU:</h3>
                <div id="lobby-player-list"
                    class="flex flex-col gap-1 max-h-40 overflow-y-auto p-3 rounded-lg text-left"
                    style="background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1);"></div>
            </div>

            <div id="host-ctrl" class="hidden"><button class="btn btn-primary" onclick="app.start()">üöÄ START
                    GRY</button></div>
            <div id="wait-msg" class="text-gray-400 animate-pulse mt-4">‚è≥ OCZEKIWANIE NA HOSTA...</div>
        </div>
    </div>

    <div id="hud">
        <div id="perf">FPS: 0 | PING: 0ms</div>
        <div class="absolute top-4 left-4 text-left mt-4">
            <div class="text-xs text-gray-400">KDA</div>
            <div id="kda-disp" class="text-lg font-mono">0 / 0</div>
        </div>

        <div id="leaderboard-panel"
            class="hidden md:block absolute top-4 right-4 w-72 bg-black/60 backdrop-blur-md border border-white/10 rounded-lg p-2 font-mono text-xs z-10">
            <div class="flex justify-between border-b border-white/20 pb-1 mb-1 text-gray-400">
                <span class="w-1/2">GRACZ</span>
                <span class="w-1/4 text-right">PKT</span>
                <span class="w-1/4 text-right">WIN üëë</span>
            </div>
            <div id="leaderboard-list"></div>
        </div>

        <div style="position:absolute; top:20px; left:50%; transform:translateX(-50%); text-align:center;">
            <div id="score-disp" class="text-4xl font-bold text-yellow-400 drop-shadow-md">0</div>
            <div id="warn-sing" class="text-purple-500 font-black text-2xl animate-ping hidden">‚ö† SINGULARITY ‚ö†</div>
        </div>
        <div id="bar-hp-c" class="hud-bar-c">
            <div id="bar-hp" class="fill bg-red-500"></div>
        </div>
        <div id="bar-xp-c" class="hud-bar-c">
            <div id="bar-xp" class="fill bg-purple-500"></div>
        </div>
        <div class="absolute bottom-[28px] left-1/2 -translate-x-1/2 text-[10px] text-gray-400" id="xp-text"></div>

        <!-- Active Perks Display -->
        <div id="active-perks" style="position:absolute; top:80px; left:20px; display:flex; gap:8px; font-size:1.5rem;">
        </div>

        <div id="cooldowns-pc" class="hidden md:flex">
            <div id="cd-dash-pc" class="cd-icon">‚ö°<div class="cd-fill" id="fill-dash"></div>
                <div class="text-[10px] absolute bottom-1 z-10">SPC</div>
            </div>
            <div id="cd-skill-pc" class="cd-icon">‚òÖ<div class="cd-fill" id="fill-skill"></div>
                <div class="text-[10px] absolute bottom-1 z-10">E</div>
            </div>
        </div>

        <div id="touch-l" class="touch-zone"></div>

        <!-- UI FIX: Buttons above minimap -->
        <div id="touch-r">
            <div class="skill-btn" id="btn-dash-m" onmousedown="app.input.d=true" onmouseup="app.input.d=false"
                ontouchstart="app.input.d=true" ontouchend="app.input.d=false">‚ö°</div>
            <div class="skill-btn" id="btn-skill-m" style="border-color:#666; color:#ffd700;"
                onmousedown="app.input.s=true" onmouseup="app.input.s=false" ontouchstart="app.input.s=true"
                ontouchend="app.input.s=false">‚òÖ</div>
        </div>

        <div id="perk-ui">
            <h2>‚¨ÜÔ∏è LEVEL UP! ‚¨ÜÔ∏è</h2>
            <p style="color:#0ff; margin-bottom:20px; font-size:1.2rem; font-weight:bold;">Naci≈õnij 1-8 aby wybraƒá:</p>
            <div id="perk-list"></div>
        </div>
        <canvas id="minimap-c" width="150" height="150"></canvas>

        <div id="chat-ui">
            <div id="chat-msgs"></div>
            <input id="chat-in" placeholder="Napisz wiadomo≈õƒá... (Enter)">
        </div>
    </div>

    <canvas id="cvs"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <script>
        const EMOTES = ['üëç', 'üëé', 'üòÇ', 'ü§¨'];

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        const app = {
            sock: null, input: { x: 0, y: 0, d: false, s: false }, myId: null, state: {}, cam: { x: 0, y: 0, z: 1.0 }, mapSize: 3000, perks: {}, winScore: 1000,
            floats: [], parts: [], walls: [], bushes: [], healSpots: [], localData: { kills: 0, wins: 0, nick: '' },
            frames: 0, lastPing: 0,
            // NEW: Enhanced visual effects
            stars: [], trails: [], shakeAmount: 0, lastPlayerPos: {},

            init() {
                this.loadData();
                this.cvs = document.getElementById('cvs'); this.ctx = this.cvs.getContext('2d');
                this.mmCvs = document.getElementById('minimap-c'); this.mmCtx = this.mmCvs.getContext('2d');
                window.addEventListener('resize', () => this.resize()); this.resize();
                this.setupInput();
                // Generate background stars
                for (let i = 0; i < 150; i++) {
                    this.stars.push({
                        x: Math.random() * 4000 - 500,
                        y: Math.random() * 4000 - 500,
                        s: Math.random() * 2 + 0.5,
                        a: Math.random() * 0.5 + 0.3,
                        sp: Math.random() * 0.003 + 0.001
                    });
                }
                setInterval(() => {
                    document.getElementById('perf').innerText = `FPS: ${this.frames} | PING: ${Date.now() - this.lastPing}ms`;
                    this.frames = 0;
                    if (this.sock) { this.lastPing = Date.now(); this.sock.emit('ping', () => { }); }
                }, 1000);
                this.loop();
            },

            loadData() {
                const d = localStorage.getItem('neon_kpn_data');
                if (d) {
                    this.localData = JSON.parse(d);
                    document.getElementById('nick').value = this.localData.nick || '';
                    document.getElementById('stats-prev').innerHTML = `<span class="text-cyan-400">üèÜ Kills:</span> ${this.localData.kills} | <span class="text-yellow-400">üëë Wins:</span> ${this.localData.wins}`;
                } else {
                    document.getElementById('stats-prev').innerHTML = `<span class="text-gray-500">Brak zapisanych statystyk</span>`;
                }
            },

            saveData() {
                this.localData.nick = document.getElementById('nick').value;
                localStorage.setItem('neon_kpn_data', JSON.stringify(this.localData));
            },

            resize() {
                this.cvs.width = window.innerWidth * window.devicePixelRatio; this.cvs.height = window.innerHeight * window.devicePixelRatio;
                this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            },
            connect() {
                this.saveData();
                this.sock = io();
                this.sock.on('roomList', list => {
                    const el = document.getElementById('rooms'); el.innerHTML = '';
                    list.forEach(r => el.innerHTML += `<div class="room-item" onclick="app.join('${r.id}', ${r.locked})"><span class="font-bold">${r.name} ${r.locked ? 'üîí' : ''}</span><span class="text-xs bg-white/10 px-2 rounded py-1">${r.mode.toUpperCase()} [${r.c}/${r.max}]</span></div>`);
                    this.screen('s-list');
                });
                this.sock.on('roomCreated', id => this.join(id, false));
                this.sock.on('joined', d => {
                    this.myId = d.id; this.mapSize = d.w; this.perks = d.perks; this.winScore = d.winScore;
                    this.walls = d.walls || []; this.bushes = d.bushes || []; this.healSpots = d.healSpots || [];
                    this.screen('s-lobby'); if (d.host) { document.getElementById('host-ctrl').classList.remove('hidden'); document.getElementById('wait-msg').classList.add('hidden'); }
                });
                this.sock.on('gameStart', () => this.screen('hud'));
                this.sock.on('gameOver', d => {
                    const me = this.state.p?.find(x => x.id === this.myId);
                    const isWinner = d.w === me?.n;
                    if (isWinner) { this.localData.wins++; this.saveData(); }

                    // Show enhanced overlay
                    const overlay = document.getElementById('game-over-overlay');
                    const title = document.getElementById('victory-title');
                    const stats = document.getElementById('victory-stats');

                    overlay.style.display = 'flex';
                    if (isWinner) {
                        title.textContent = 'üèÜ ZWYCIƒòSTWO! üèÜ';
                        title.className = 'victory-text win';
                        // Spawn celebration particles
                        for (let i = 0; i < 50; i++) {
                            this.parts.push({
                                x: window.innerWidth / 2 + (Math.random() - 0.5) * 400,
                                y: window.innerHeight / 2,
                                dx: (Math.random() - 0.5) * 15, dy: -Math.random() * 15 - 5,
                                c: ['#ffd700', '#ff6b6b', '#4ade80', '#60a5fa'][Math.floor(Math.random() * 4)],
                                l: 100 + Math.random() * 50, s: Math.random() * 6 + 3
                            });
                        }
                    } else {
                        title.textContent = 'PRZEGRANA';
                        title.className = 'victory-text lose';
                    }
                    stats.innerHTML = `Zwyciƒôzca: <span style="color:#ffd700">${d.w.toUpperCase()}</span><br>Tw√≥j wynik: ${me?.score || 0} pkt | Zab√≥jstwa: ${me?.kills || 0}`;

                    setTimeout(() => { overlay.style.display = 'none'; this.screen('s-lobby'); }, 6000);
                });
                this.sock.on('u', p => {
                    this.state = p;
                    const me = p.p.find(x => x.id === this.myId);

                    const lobbyList = document.getElementById('lobby-player-list');
                    if (lobbyList && document.getElementById('s-lobby').classList.contains('active')) {
                        document.getElementById('roster-header').innerText = `GRACZE W POKOJU (${p.p.length}/25):`;
                        lobbyList.innerHTML = p.p.map(pl => `
                            <div class="flex justify-between items-center text-xs p-1 ${pl.id === this.myId ? 'text-yellow-400 bg-white/10' : 'text-gray-300'}">
                                <span>${pl.n}</span>
                                <span class="uppercase font-bold" style="color:${pl.t === 'rock' ? '#ef4444' : (pl.t === 'paper' ? '#3b82f6' : '#22c55e')}">${pl.t}</span>
                            </div>
                        `).join('');
                    }

                    const lb = document.getElementById('leaderboard-list');
                    lb.innerHTML = p.p.filter(x => x.a).sort((a, b) => b.score - a.score).slice(0, 5).map(pl => `
                        <div class="flex justify-between ${pl.id === this.myId ? 'text-yellow-400 font-bold' : ''}">
                            <span class="w-1/2 truncate">${pl.n}</span>
                            <span class="w-1/4 text-right">${pl.score}</span>
                            <span class="w-1/4 text-right text-yellow-500">${pl.rw || 0}</span>
                        </div>
                    `).join('');

                    if (me) {
                        this.cam.x += (me.x - this.cam.x) * 0.1; this.cam.y += (me.y - this.cam.y) * 0.1;
                        if (me.a) {
                            document.getElementById('bar-hp').style.width = (me.hp / me.mhp) * 100 + '%';
                            document.getElementById('bar-xp').style.width = (me.xp / me.nxp) * 100 + '%';
                            document.getElementById('score-disp').innerText = me.score + " / " + this.winScore;
                            document.getElementById('kda-disp').innerText = `${me.kills} / ${me.deaths}`;
                            document.getElementById('xp-text').innerText = `${me.xp} / ${me.nxp} XP`;

                            // Store my perks for filtering
                            this.myPerks = me.perks || [];

                            // Display active perks
                            const perkIcons = { vamp: 'üßõ', glass: 'üíé', tank: 'üõ°Ô∏è', speed: '‚ö°', regen: 'üíö', crit: 'üéØ', dodge: 'üåÄ', magnet: 'üß≤' };
                            document.getElementById('active-perks').innerHTML = this.myPerks.map(p =>
                                `<span title="${p}" style="background:rgba(0,0,0,0.5);padding:5px;border-radius:8px;border:1px solid #0ff;">${perkIcons[p] || '‚ú®'}</span>`
                            ).join('');

                            if (me.pen) this.showPerks(); else document.getElementById('perk-ui').style.display = 'none';

                            // UPDATE COOLDOWNS
                            const updateCD = (val, max, elId, fillId) => {
                                const el = document.getElementById(elId);
                                const fill = document.getElementById(fillId);
                                if (val <= 0) { el.classList.add('ready'); el.style.borderColor = '#0f0'; if (fill) fill.style.height = '0%'; }
                                else { el.classList.remove('ready'); el.style.borderColor = '#666'; if (fill) fill.style.height = ((val / max) * 100) + '%'; }
                            };

                            updateCD(me.dcd, 60, 'cd-dash-pc', 'fill-dash');
                            updateCD(me.scd, me.mscd, 'cd-skill-pc', 'fill-skill');

                            updateCD(me.dcd, 60, 'btn-dash-m', null);
                            updateCD(me.scd, me.mscd, 'btn-skill-m', null);
                        }
                    }
                    if (p.st.sz < this.mapSize) {
                        const warn = document.getElementById('warn-sing');
                        warn.innerText = "BURZA NADCHODZI!";
                        warn.classList.remove('hidden');
                    }
                });
                this.sock.on('fx', d => {
                    if (d.t === 'kill') {
                        // Kill Feed
                        this.addKillFeed(d.msg);
                        this.shakeScreen(8);
                        if (d.msg.includes(this.localData.nick)) {
                            this.localData.kills++; this.saveData();
                            // Extra particles for your own kills
                            for (let i = 0; i < 15; i++) {
                                this.parts.push({
                                    x: d.x, y: d.y,
                                    dx: (Math.random() - 0.5) * 20, dy: (Math.random() - 0.5) * 20,
                                    c: '#ffd700', l: 40, s: Math.random() * 5 + 2
                                });
                            }
                        }
                    }
                    if (d.t === 'dmg') {
                        this.floats.push({ x: d.x, y: d.y, t: d.v, c: d.c, l: 1.0 });
                        // Shake on damage to self
                        const me = this.state.p?.find(x => x.id === this.myId);
                        if (me && Math.hypot(me.x - d.x, me.y - d.y) < 50) this.shakeScreen(3);
                    }
                    if (d.t === 'emote') this.floats.push({ x: this.state.p.find(x => x.id === d.id)?.x, y: this.state.p.find(x => x.id === d.id)?.y, t: EMOTES[d.e], c: '#fff', l: 2.0, font: 40 });
                    if (d.t === 'part') {
                        for (let i = 0; i < d.n; i++) {
                            this.parts.push({
                                x: d.x, y: d.y,
                                dx: (Math.random() - 0.5) * 12, dy: (Math.random() - 0.5) * 12,
                                c: d.c, l: 35 + Math.random() * 25, s: Math.random() * 5 + 2
                            });
                        }
                    }
                    if (d.t === 'streak' && d.k >= 2) {
                        this.showStreak(d.k, d.n);
                    }
                });

                this.sock.on('chatMsg', d => {
                    const c = document.getElementById('chat-msgs');
                    c.innerHTML += `<div class="mb-1"><span class="font-bold text-cyan-400">${d.n}:</span> ${d.m}</div>`;
                    c.scrollTop = c.scrollHeight;
                });

                // Zamiast autojoin, pobieramy listƒô pokoi
                this.sock.emit('getRooms');
            },

            // NEW: Kill Feed
            addKillFeed(msg) {
                const feed = document.getElementById('kill-feed');
                const item = document.createElement('div');
                item.className = 'kill-item';
                item.innerHTML = msg;
                feed.appendChild(item);
                setTimeout(() => item.remove(), 3000);
                // Limit feed items
                while (feed.children.length > 5) feed.removeChild(feed.firstChild);
            },

            // NEW: Screen Shake
            shakeScreen(amount) {
                this.shakeAmount = Math.max(this.shakeAmount, amount);
            },

            // NEW: Streak Popup
            showStreak(count, playerName) {
                const popup = document.createElement('div');
                popup.className = 'streak-popup';
                popup.innerHTML = `üî• ${playerName} - ${count}x STREAK!`;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 1500);
            },

            // NEW: Close Overlay
            closeOverlay() {
                document.getElementById('game-over-overlay').style.display = 'none';
                this.screen('s-lobby');
            },

            join(id, locked) { const pass = locked ? prompt("Has≈Ço:") : ""; this.sock.emit('join', { roomId: id, nick: document.getElementById('nick').value, pass }); },
            createRoom() { const n = document.getElementById('c-name').value; const p = document.getElementById('c-pass').value; const m = document.getElementById('c-mode').value; if (n) this.sock.emit('createRoom', { name: n, pass: p, mode: m }); },
            screen(id) { document.querySelectorAll('.ui-screen').forEach(e => e.classList.remove('active')); const el = document.getElementById(id); if (el) el.classList.add('active'); const h = document.getElementById('hud'); if (id === 'hud') h.style.display = 'block'; else h.style.display = 'none'; },
            setType(t) { document.querySelectorAll('.class-card').forEach(e => e.classList.remove('sel')); document.getElementById('c-' + t).classList.add('sel'); this.sock.emit('setType', t); },
            start() { this.sock.emit('hostStart'); },
            showPerks() {
                const l = document.getElementById('perk-list');
                l.innerHTML = '';
                // All 8 perk icons
                const icons = { vamp: 'üßõ', glass: 'üíé', tank: 'üõ°Ô∏è', speed: '‚ö°', regen: 'üíö', crit: 'üéØ', dodge: 'üåÄ', magnet: 'üß≤' };
                let idx = 0;
                const ownedPerks = this.myPerks || [];
                const availablePerks = Object.keys(this.perks).filter(k => !ownedPerks.includes(k));

                for (let k of availablePerks) {
                    const icon = icons[k] || '‚ú®';
                    idx++;
                    l.innerHTML += `<div class="perk-opt" data-perk="${k}" onclick="app.pickPerk('${k}')" ontouchend="app.pickPerk('${k}'); event.preventDefault();">
                        <div style="position:absolute;top:8px;left:12px;font-size:1.5rem;color:#ffd700;font-weight:900;">${idx}</div>
                        <span class="perk-icon">${icon}</span>
                        <div class="font-bold text-cyan-300 text-lg">${this.perks[k].n}</div>
                        <div class="text-xs text-gray-400 mt-2">${this.perks[k].d}</div>
                    </div>`;
                }
                this.perkKeys = availablePerks; // Store available perk keys for keyboard selection
                document.getElementById('perk-ui').style.display = 'block';
            },
            pickPerk(pid) { this.sock.emit('perk', pid); document.getElementById('perk-ui').style.display = 'none'; },
            toast(msg) {
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerText = msg;
                document.getElementById('toasts').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },
            setupInput() {
                window.onkeydown = e => {
                    if (document.activeElement === document.getElementById('chat-in')) {
                        if (e.key === 'Enter') {
                            const txt = e.target.value;
                            if (txt) this.sock.emit('chat', txt);
                            e.target.value = ''; document.getElementById('chat-in').style.display = 'none';
                        }
                        return;
                    }

                    // PERK SELECTION with 1-8 keys
                    if (['1', '2', '3', '4', '5', '6', '7', '8'].includes(e.key) && document.getElementById('perk-ui').style.display === 'block') {
                        const idx = parseInt(e.key) - 1;
                        if (this.perkKeys && this.perkKeys[idx]) {
                            this.pickPerk(this.perkKeys[idx]);
                            return;
                        }
                    }

                    if (e.key === 'w') this.input.y = -1; if (e.key === 's') this.input.y = 1; if (e.key === 'a') this.input.x = -1; if (e.key === 'd') this.input.x = 1; if (e.code === 'Space') this.input.d = true; if (e.key === 'e') this.input.s = true;
                    if (['1', '2', '3', '4'].includes(e.key) && document.getElementById('perk-ui').style.display !== 'block') this.sock.emit('emote', parseInt(e.key) - 1);
                    if (e.key === 'Enter') {
                        const cin = document.getElementById('chat-in');
                        cin.style.display = 'block'; cin.focus();
                    }
                };
                window.onkeyup = e => { if (e.key === 'w' || e.key === 's') this.input.y = 0; if (e.key === 'a' || e.key === 'd') this.input.x = 0; if (e.code === 'Space') this.input.d = false; if (e.key === 'e') this.input.s = false; };
                const mgr = nipplejs.create({ zone: document.getElementById('touch-l'), mode: 'static', position: { left: '50%', top: '50%' }, color: 'white' });
                mgr.on('move', (e, d) => { if (d.vector) { this.input.x = d.vector.x; this.input.y = -d.vector.y; } });
                mgr.on('end', () => { this.input.x = 0; this.input.y = 0; });
            },
            loop() {
                requestAnimationFrame(() => this.loop());
                if (this.sock) this.sock.emit('input', this.input);
                if (this.state.p && this.state.p.find(p => p.id === this.myId && p.pen)) this.showPerks();
                // Decay screen shake
                if (this.shakeAmount > 0) this.shakeAmount *= 0.85;
                this.render();
                this.frames++;
            },
            render() {
                const ms = 150 / 3000;
                this.ctx.globalAlpha = 1;

                const w = window.innerWidth, h = window.innerHeight;

                // Apply screen shake
                let shakeX = 0, shakeY = 0;
                if (this.shakeAmount > 0.5) {
                    shakeX = (Math.random() - 0.5) * this.shakeAmount * 2;
                    shakeY = (Math.random() - 0.5) * this.shakeAmount * 2;
                }

                // Dark gradient background
                const bgGrad = this.ctx.createRadialGradient(w / 2, h / 2, 0, w / 2, h / 2, Math.max(w, h));
                bgGrad.addColorStop(0, '#0d0d1a');
                bgGrad.addColorStop(1, '#050508');
                this.ctx.fillStyle = bgGrad;
                this.ctx.fillRect(0, 0, w, h);

                if (!this.state || !this.state.p) return;

                this.ctx.save();
                this.ctx.translate(w / 2 + shakeX, h / 2 + shakeY);
                this.ctx.scale(this.cam.z, this.cam.z);
                this.ctx.translate(-this.cam.x, -this.cam.y);

                // Draw background stars (parallax)
                this.ctx.globalAlpha = 0.6;
                const time = Date.now();
                for (const star of this.stars) {
                    const twinkle = Math.sin(time * star.sp) * 0.3 + 0.7;
                    this.ctx.fillStyle = `rgba(255,255,255,${star.a * twinkle})`;
                    this.ctx.beginPath();
                    this.ctx.arc(star.x, star.y, star.s, 0, Math.PI * 2);
                    this.ctx.fill();
                }
                this.ctx.globalAlpha = 1;

                // --- CLIP MAP AREA (CIRCLE) ---
                this.ctx.save();
                this.ctx.beginPath(); this.ctx.arc(1500, 1500, 1500, 0, Math.PI * 2);
                this.ctx.clip();

                // Grid with Pulse
                const pulse = Math.sin(Date.now() / 1000) * 0.1 + 0.9;
                this.ctx.strokeStyle = `rgba(26, 26, 46, ${pulse})`; this.ctx.lineWidth = 2; this.ctx.beginPath();
                for (let i = 0; i <= 3000; i += 250) { this.ctx.moveTo(i, 0); this.ctx.lineTo(i, 3000); this.ctx.moveTo(0, i); this.ctx.lineTo(3000, i); } this.ctx.stroke();

                const zr = this.state.st.sz;
                if (zr < 1500) {
                    this.ctx.beginPath(); this.ctx.arc(1500, 1500, 1500, 0, Math.PI * 2); this.ctx.arc(1500, 1500, zr, 0, Math.PI * 2, true);
                    this.ctx.fillStyle = 'rgba(255, 0, 0, 0.2)'; this.ctx.fill();

                    // Storm Pulse
                    this.ctx.beginPath(); this.ctx.arc(1500, 1500, zr, 0, Math.PI * 2);
                    this.ctx.strokeStyle = `rgba(255, 0, 0, ${pulse})`; this.ctx.lineWidth = 5 + pulse * 5; this.ctx.stroke();
                }

                this.bushes.forEach(b => { this.ctx.fillStyle = '#004d00'; this.ctx.beginPath(); this.ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2); this.ctx.fill(); this.ctx.strokeStyle = '#006600'; this.ctx.lineWidth = 5; this.ctx.stroke(); });

                this.healSpots.forEach(h => {
                    this.ctx.fillStyle = `rgba(0, 255, 0, 0.2)`;
                    this.ctx.beginPath(); this.ctx.arc(h.x, h.y, h.r + Math.sin(Date.now() / 500) * 5, 0, Math.PI * 2); this.ctx.fill();
                    this.ctx.fillStyle = '#0f0'; this.ctx.font = '30px Arial'; this.ctx.fillText('+', h.x - 10, h.y + 10);
                });

                // Draw ZONES with enhanced visuals (FIXED: using actual coordinates, not minimap scale)
                if (this.state.z) {
                    const pulse = Math.sin(Date.now() / 800) * 0.15 + 0.85;
                    this.state.z.forEach(z => {
                        const color = z.t === 'rock' ? '#ef4444' : (z.t === 'paper' ? '#3b82f6' : '#22c55e');
                        const emoji = z.t === 'rock' ? 'ü™®' : (z.t === 'paper' ? 'üìÑ' : '‚úÇÔ∏è');

                        // Zone glow
                        this.ctx.shadowBlur = 30;
                        this.ctx.shadowColor = color;

                        // Filled zone
                        this.ctx.fillStyle = color;
                        this.ctx.globalAlpha = 0.15 * pulse;
                        this.ctx.beginPath();
                        this.ctx.arc(z.x, z.y, 160, 0, Math.PI * 2);
                        this.ctx.fill();

                        // Zone border ring
                        this.ctx.globalAlpha = 0.6 * pulse;
                        this.ctx.strokeStyle = color;
                        this.ctx.lineWidth = 4;
                        this.ctx.beginPath();
                        this.ctx.arc(z.x, z.y, 160, 0, Math.PI * 2);
                        this.ctx.stroke();

                        // Inner ring pulse
                        this.ctx.globalAlpha = 0.3;
                        this.ctx.lineWidth = 2;
                        this.ctx.beginPath();
                        this.ctx.arc(z.x, z.y, 120 + Math.sin(Date.now() / 500) * 10, 0, Math.PI * 2);
                        this.ctx.stroke();

                        // Zone icon
                        this.ctx.globalAlpha = 0.8;
                        this.ctx.shadowBlur = 0;
                        this.ctx.font = '50px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.textBaseline = 'middle';
                        this.ctx.fillText(emoji, z.x, z.y);

                        this.ctx.globalAlpha = 1;
                        this.ctx.shadowBlur = 0;
                    });
                }
                this.state.o.forEach(o => { this.ctx.fillStyle = '#ffd700'; this.ctx.shadowColor = '#ffd700'; this.ctx.shadowBlur = 10; this.ctx.beginPath(); this.ctx.arc(o[0], o[1], 5, 0, Math.PI * 2); this.ctx.fill(); this.ctx.shadowBlur = 0; });

                this.ctx.fillStyle = '#222'; this.ctx.strokeStyle = '#0ff'; this.ctx.lineWidth = 3;
                this.walls.forEach(wa => { this.ctx.shadowBlur = 15; this.ctx.shadowColor = '#0ff'; this.ctx.fillRect(wa.x, wa.y, wa.w, wa.h); this.ctx.strokeRect(wa.x, wa.y, wa.w, wa.h); this.ctx.shadowBlur = 0; });

                this.ctx.restore(); // End Clip (Camera transform still active)
                this.ctx.beginPath(); this.ctx.arc(1500, 1500, 1500, 0, Math.PI * 2); this.ctx.strokeStyle = '#444'; this.ctx.lineWidth = 10; this.ctx.stroke();

                const drawUnit = (x, y, t, r, inv, my, invuln) => {
                    // Reset Alpha at start of unit draw
                    this.ctx.globalAlpha = 1;

                    const c = t === 'rock' ? '#ef4444' : (t === 'paper' ? '#3b82f6' : (t === 'zombie' ? '#777' : '#22c55e'));
                    this.ctx.fillStyle = c;

                    if (inv) this.ctx.globalAlpha = my ? 0.5 : 0;
                    if (invuln) this.ctx.globalAlpha = (Date.now() % 200 < 100) ? 0.5 : 1;

                    if (t === 'zombie') {
                        // GLITCH EFFECT RENDER
                        this.ctx.save();
                        this.ctx.translate(x, y);
                        const jitX = (Math.random() - 0.5) * 4;
                        const jitY = (Math.random() - 0.5) * 4;
                        this.ctx.fillStyle = '#00ff00'; this.ctx.fillRect(-15 + jitX, -15, 30, 30);
                        this.ctx.fillStyle = '#ff00ff'; this.ctx.fillRect(-15 - jitX, -15, 30, 30);
                        this.ctx.fillStyle = '#fff'; this.ctx.fillRect(-15, -15, 30, 30);
                        this.ctx.restore();
                    } else {
                        // PLAYER GLOW
                        this.ctx.shadowBlur = 10; this.ctx.shadowColor = c;
                        this.ctx.beginPath(); this.ctx.arc(x, y, r, 0, Math.PI * 2); this.ctx.fill();
                        this.ctx.shadowBlur = 0;
                        this.ctx.fillStyle = '#fff'; this.ctx.font = `${r}px Arial`; this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle'; this.ctx.fillText(t === 'rock' ? 'ü™®' : (t === 'paper' ? 'üìÑ' : (t === 'zombie' ? '' : '‚úÇÔ∏è')), x, y);
                    }
                    this.ctx.globalAlpha = 1;
                };

                // Particles
                this.parts = this.parts.filter(p => {
                    p.x += p.dx; p.y += p.dy; p.l--;
                    this.ctx.fillStyle = p.c; this.ctx.fillRect(p.x, p.y, p.s, p.s);
                    return p.l > 0;
                });

                this.state.m.forEach(m => drawUnit(m.x, m.y, m.t, 18, false, false, false));
                this.state.p.forEach(p => {
                    if (!p.a || (p.inv && p.id !== this.myId)) return;
                    if (p.inBush) this.ctx.globalAlpha = 0.6;
                    drawUnit(p.x, p.y, p.t, 28, p.inv, p.id === this.myId, p.invuln);
                    this.ctx.globalAlpha = 1;
                    this.ctx.fillStyle = '#fff'; this.ctx.font = '10px Arial'; this.ctx.fillText(p.n, p.x, p.y - 40);
                    this.ctx.fillStyle = '#333'; this.ctx.fillRect(p.x - 20, p.y - 35, 40, 4); this.ctx.fillStyle = '#0f0'; this.ctx.fillRect(p.x - 20, p.y - 35, 40 * (p.hp / p.mhp), 4);
                });

                this.floats = this.floats.filter(f => {
                    f.y -= 1; f.l -= 0.02;
                    this.ctx.globalAlpha = Math.max(0, f.l);
                    this.ctx.fillStyle = f.c; this.ctx.font = `bold ${f.font || 20}px Arial`;
                    this.ctx.fillText(f.t, f.x, f.y);
                    this.ctx.globalAlpha = 1;
                    return f.l > 0;
                });

                this.ctx.restore(); // Restore camera transform

                // Minimap
                this.mmCtx.clearRect(0, 0, 150, 150);
                this.mmCtx.fillStyle = '#111'; this.mmCtx.beginPath(); this.mmCtx.arc(75, 75, 75, 0, Math.PI * 2); this.mmCtx.fill(); // Map BG

                this.mmCtx.fillStyle = '#444'; this.walls.forEach(w => this.mmCtx.fillRect(w.x * ms, w.y * ms, w.w * ms, w.h * ms));

                // --- FIX: Add Bushes & Heal Spots to Minimap ---
                this.mmCtx.fillStyle = '#004d00';
                this.bushes.forEach(b => { this.mmCtx.beginPath(); this.mmCtx.arc(b.x * ms, b.y * ms, b.r * ms, 0, Math.PI * 2); this.mmCtx.fill(); });

                this.mmCtx.fillStyle = '#0f0';
                this.healSpots.forEach(h => { this.mmCtx.beginPath(); this.mmCtx.arc(h.x * ms, h.y * ms, h.r * ms, 0, Math.PI * 2); this.mmCtx.fill(); });
                // -----------------------------------------------

                if (zr < 1500) { this.mmCtx.strokeStyle = '#f00'; this.mmCtx.beginPath(); this.mmCtx.arc(75, 75, zr * ms, 0, Math.PI * 2); this.mmCtx.stroke(); }
                if (this.state.z) this.state.z.forEach(z => { this.mmCtx.strokeStyle = z.t === 'rock' ? '#f00' : (z.t === 'paper' ? '#00f' : '#0f0'); this.mmCtx.beginPath(); this.mmCtx.arc(z.x * ms, z.y * ms, 150 * ms, 0, Math.PI * 2); this.mmCtx.stroke(); });
                if (this.state.p) this.state.p.forEach(p => { if (p.a && (!p.inv || p.id === this.myId)) { this.mmCtx.fillStyle = p.id === this.myId ? '#fff' : '#f00'; this.mmCtx.beginPath(); this.mmCtx.arc(p.x * ms, p.y * ms, 2, 0, Math.PI * 2); this.mmCtx.fill(); } });
            }
        };
        window.onload = () => app.init();
    </script>
</body>

</html>