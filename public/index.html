<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon KPN - Particles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap');
        body { background: #050508; color: #eee; font-family: 'Rajdhani', sans-serif; overflow: hidden; touch-action: none; user-select: none; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .ui-screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; opacity: 0; pointer-events: none; transition: 0.3s; background: rgba(5,5,8,0.95); }
        .ui-screen.active { opacity: 1; pointer-events: auto; }
        .panel { background: rgba(20,20,30,0.6); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(12px); padding: 2rem; border-radius: 1rem; box-shadow: 0 0 30px rgba(0,0,0,0.5); width: 100%; max-width: 400px; text-align: center; }
        .inp { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 12px; color: white; border-radius: 8px; margin-bottom: 10px; outline: none; transition: 0.2s; font-family: inherit; font-size: 1.1rem; }
        .btn { width: 100%; padding: 12px; font-weight: 700; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; letter-spacing: 1px; font-size: 1.1rem; margin-top: 5px; }
        .btn-primary { background: linear-gradient(135deg, #00c6ff, #0072ff); color: white; box-shadow: 0 4px 15px rgba(0,114,255,0.3); }
        .btn-sec { background: transparent; color: #888; margin-top: 10px; }

        .room-item { display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .room-item:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .class-card { width: 90px; height: 120px; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; margin: 0 10px; }
        .class-card.sel { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        
        #hud { position: absolute; inset: 0; pointer-events: none; display: none; }
        .hud-bar-c { position: absolute; left: 50%; transform: translateX(-50%); width: 300px; height: 8px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        #bar-hp-c { bottom: 60px; } #bar-xp-c { bottom: 45px; height: 4px; width: 250px; }
        .fill { height: 100%; width: 100%; transition: width 0.2s ease-out; }
        
        .touch-zone { position: absolute; bottom: 40px; width: 140px; height: 140px; pointer-events: auto; }
        #touch-l { left: 40px; } 
        
        /* FIX: Buttons and PC Cooldowns above minimap */
        #touch-r { 
            position: absolute;
            bottom: 180px; 
            right: 20px; 
            display: flex; 
            gap: 15px; 
            align-items: flex-end; 
            justify-content: flex-end; 
            pointer-events: auto;
        }
        
        .skill-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 3px solid #666; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; transition: 0.2s; position: relative; overflow: hidden; }
        .skill-btn.ready { border-color: #0f0; box-shadow: 0 0 15px rgba(0,255,0,0.5); }
        
        /* PC Cooldowns - Moved above minimap (same pos as touch-r) */
        #cooldowns-pc { 
            position: absolute; 
            bottom: 180px; 
            right: 20px; 
            display: flex; 
            gap: 15px; 
            pointer-events: none; 
        }
        .cd-icon { width: 60px; height: 60px; border: 3px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #fff; background: rgba(0,0,0,0.5); position: relative; overflow: hidden; font-size: 24px; }
        .cd-icon.ready { border-color: #0f0; box-shadow: 0 0 10px #0f0; }
        .cd-fill { position: absolute; inset: 0; background: rgba(0,0,0,0.7); transform-origin: center; transition: 0.1s; }

        /* Hide touch zones on PC */
        @media (pointer: fine) { .touch-zone { display: none !important; } }
        /* Hide PC Cooldowns on Mobile */
        @media (pointer: coarse) { #cooldowns-pc { display: none !important; } }
        
        #perk-ui { position: absolute; top: 20%; width: 100%; text-align: center; pointer-events: auto; display: none; }
        .perk-opt { display: inline-block; background: #1a1a2e; border: 1px solid #0ff; padding: 20px; margin: 10px; width: 160px; border-radius: 10px; cursor: pointer; transition: 0.2s; box-shadow: 0 0 15px rgba(0,255,255,0.1); }

        #minimap-c { 
            position: absolute; 
            z-index: 5; 
            background: rgba(0,0,0,0.5); 
            border: 1px solid #444; 
            border-radius: 50%; 
            overflow: hidden; 
            pointer-events: none; 
            bottom: 20px; 
            right: 20px; 
            width: 150px; 
            height: 150px;
        }
        
        #chat-ui { position: absolute; bottom: 20px; left: 20px; width: 300px; height: 200px; pointer-events: auto; display: flex; flex-direction: column; }
        #chat-msgs { flex: 1; overflow-y: auto; text-shadow: 0 0 2px black; font-size: 12px; }
        #chat-in { background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; padding: 5px; outline: none; display: none; }
        
        #perf { position: absolute; top: 5px; left: 5px; font-size: 10px; color: #0f0; }

        .toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,0,0,0.8); padding: 10px 20px; border-radius: 20px; font-weight: bold; animation: fadeUp 3s forwards; }
        @keyframes fadeUp { 0% {opacity:0; transform:translate(-50%, 20px);} 10% {opacity:1; transform:translate(-50%, 0);} 80% {opacity:1;} 100% {opacity:0;} }
        
        #btn-fs { position: fixed; top: 20px; right: 20px; z-index: 100; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.2); color: white; width: 40px; height: 40px; border-radius: 8px; font-size: 20px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        #btn-fs:hover { background: rgba(255, 255, 255, 0.1); border-color: white; }
    </style>
</head>
<body>
    <div id="toasts"></div>
    <button id="btn-fs" onclick="toggleFullScreen()">‚õ∂</button>

    <div id="s-login" class="ui-screen active">
        <h1 class="text-7xl font-black mb-1 bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-500">NEON KPN</h1>
        <p class="text-gray-400 mb-8 tracking-widest text-xs">V16.6 (RENDER FIX)</p>
        <div class="panel">
            <input id="nick" class="inp" placeholder="Tw√≥j Nick" maxlength="15">
            <div id="stats-prev" class="text-xs text-gray-500 mt-2 mb-2">≈Åadowanie statystyk...</div>
            <button class="btn btn-primary" onclick="app.connect()">GRAJ</button>
            <button class="btn btn-sec" onclick="app.screen('s-manual')">JAK GRAƒÜ?</button>
        </div>
    </div>

    <div id="s-manual" class="ui-screen">
        <div class="panel" style="max-width:800px; text-align:left;">
            <h1 class="text-3xl font-black mb-4 text-center">JAK GRAƒÜ?</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h3 class="text-xl font-bold text-yellow-400 mb-2">STEROWANIE</h3>
                    <ul class="list-disc pl-5 text-gray-300 space-y-1">
                        <li><b class="text-white">WSAD / Joystick:</b> Poruszanie siƒô</li>
                        <li><b class="text-white">SPACJA / Przycisk ‚ö°:</b> Dash (Sprint)</li>
                        <li><b class="text-white">E / Przycisk ‚òÖ:</b> Umiejƒôtno≈õƒá Specjalna</li>
                        <li><b class="text-white">Enter:</b> Czat</li>
                        <li><b class="text-white">1-4:</b> Emotki</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-blue-400 mb-2">ZASADY KPN</h3>
                    <ul class="list-disc pl-5 text-gray-300 space-y-1">
                        <li><span class="text-red-500">ü™® KAMIE≈É</span> bije <span class="text-green-500">‚úÇÔ∏è NO≈ªYCE</span></li>
                        <li><span class="text-green-500">‚úÇÔ∏è NO≈ªYCE</span> bijƒÖ <span class="text-blue-500">üìÑ PAPIER</span></li>
                        <li><span class="text-blue-500">üìÑ PAPIER</span> bije <span class="text-red-500">ü™® KAMIE≈É</span></li>
                        <li>Unikaj <span class="text-purple-500">BURZY</span> (czerwona strefa)!</li>
                    </ul>
                </div>
            </div>
            <h3 class="text-xl font-bold text-green-400 mt-4 mb-2">NOWO≈öCI V16.6</h3>
            <ul class="list-disc pl-5 text-gray-300 space-y-1 text-sm">
                <li><strong class="text-white">RENDER FIX:</strong> Usuniƒôto b≈ÇƒÖd znikajƒÖcych postaci.</li>
                <li><strong class="text-white">UI FIX:</strong> Wszystkie przyciski sƒÖ teraz nad minimapƒÖ.</li>
            </ul>
            <button class="btn btn-primary mt-6" onclick="app.screen('s-login')">ROZUMIEM, JAZDA!</button>
        </div>
    </div>

    <div id="s-list" class="ui-screen">
        <h2 class="text-3xl font-bold mb-6">SERWERY</h2>
        <div class="panel" style="max-width: 500px;">
            <div id="rooms" class="text-left mb-4 overflow-y-auto" style="max-height: 300px;"></div>
            <button class="btn btn-primary" onclick="app.screen('s-create')">NOWY POK√ìJ</button>
            <button class="btn btn-sec" onclick="app.screen('s-login')">POWR√ìT</button>
        </div>
    </div>

    <div id="s-create" class="ui-screen">
        <div class="panel">
            <h2 class="text-2xl font-bold mb-4">NOWY POK√ìJ</h2>
            <input id="c-name" class="inp" placeholder="Nazwa">
            <select id="c-mode" class="inp bg-black">
                <option value="play">STANDARD</option>
                <option value="koth">KING OF THE HILL</option>
            </select>
            <input id="c-pass" class="inp" placeholder="Has≈Ço (opcjonalne)">
            <button class="btn btn-primary" onclick="app.createRoom()">STW√ìRZ</button>
            <button class="btn btn-sec" onclick="app.screen('s-list')">ANULUJ</button>
        </div>
    </div>

    <div id="s-lobby" class="ui-screen">
        <div class="panel" style="max-width: 600px;">
            <div class="flex justify-center mb-8" id="class-sel">
                <div class="w-24 h-32 border-2 border-gray-600 rounded-lg m-2 flex flex-col items-center justify-center cursor-pointer hover:border-white" onclick="app.setType('rock')" id="c-rock"><div class="text-4xl">ü™®</div><div class="text-red-400 font-bold">TANK</div></div>
                <div class="w-24 h-32 border-2 border-gray-600 rounded-lg m-2 flex flex-col items-center justify-center cursor-pointer hover:border-white" onclick="app.setType('paper')" id="c-paper"><div class="text-4xl">üìÑ</div><div class="text-blue-400 font-bold">SPEED</div></div>
                <div class="w-24 h-32 border-2 border-gray-600 rounded-lg m-2 flex flex-col items-center justify-center cursor-pointer hover:border-white" onclick="app.setType('scissors')" id="c-scissors"><div class="text-4xl">‚úÇÔ∏è</div><div class="text-green-400 font-bold">DPS</div></div>
            </div>
            
            <div class="w-full mb-4">
                <h3 class="text-gray-400 text-sm font-bold mb-2 text-left" id="roster-header">GRACZE W POKOJU:</h3>
                <div id="lobby-player-list" class="flex flex-col gap-1 max-h-40 overflow-y-auto bg-black/40 p-2 rounded border border-white/10 text-left"></div>
            </div>

            <div id="host-ctrl" class="hidden"><button class="btn btn-primary" onclick="app.start()">START</button></div>
            <div id="wait-msg" class="text-gray-400 animate-pulse mt-4">OCZEKIWANIE NA HOSTA...</div>
        </div>
    </div>

    <div id="hud">
        <div id="perf">FPS: 0 | PING: 0ms</div>
        <div class="absolute top-4 left-4 text-left mt-4">
            <div class="text-xs text-gray-400">KDA</div>
            <div id="kda-disp" class="text-lg font-mono">0 / 0</div>
        </div>
        
        <div id="leaderboard-panel" class="hidden md:block absolute top-4 right-4 w-72 bg-black/60 backdrop-blur-md border border-white/10 rounded-lg p-2 font-mono text-xs z-10">
            <div class="flex justify-between border-b border-white/20 pb-1 mb-1 text-gray-400">
                <span class="w-1/2">GRACZ</span>
                <span class="w-1/4 text-right">PKT</span>
                <span class="w-1/4 text-right">WIN üëë</span>
            </div>
            <div id="leaderboard-list"></div>
        </div>

        <div style="position:absolute; top:20px; left:50%; transform:translateX(-50%); text-align:center;">
            <div id="score-disp" class="text-4xl font-bold text-yellow-400 drop-shadow-md">0</div>
            <div id="warn-sing" class="text-purple-500 font-black text-2xl animate-ping hidden">‚ö† SINGULARITY ‚ö†</div>
        </div>
        <div id="bar-hp-c" class="hud-bar-c"><div id="bar-hp" class="fill bg-red-500"></div></div>
        <div id="bar-xp-c" class="hud-bar-c"><div id="bar-xp" class="fill bg-purple-500"></div></div>
        <div class="absolute bottom-[28px] left-1/2 -translate-x-1/2 text-[10px] text-gray-400" id="xp-text"></div>
        
        <div id="cooldowns-pc" class="hidden md:flex">
            <div id="cd-dash-pc" class="cd-icon">‚ö°<div class="cd-fill" id="fill-dash"></div><div class="text-[10px] absolute bottom-1 z-10">SPC</div></div>
            <div id="cd-skill-pc" class="cd-icon">‚òÖ<div class="cd-fill" id="fill-skill"></div><div class="text-[10px] absolute bottom-1 z-10">E</div></div>
        </div>

        <div id="touch-l" class="touch-zone"></div>
        
        <!-- UI FIX: Buttons above minimap -->
        <div id="touch-r">
            <div class="skill-btn" id="btn-dash-m" onmousedown="app.input.d=true" onmouseup="app.input.d=false" ontouchstart="app.input.d=true" ontouchend="app.input.d=false">‚ö°</div>
            <div class="skill-btn" id="btn-skill-m" style="border-color:#666; color:#ffd700;" onmousedown="app.input.s=true" onmouseup="app.input.s=false" ontouchstart="app.input.s=true" ontouchend="app.input.s=false">‚òÖ</div>
        </div>
        
        <div id="perk-ui"><h2 class="text-3xl font-black text-yellow-400 drop-shadow-lg mb-4">LEVEL UP!</h2><div id="perk-list"></div></div>
        <canvas id="minimap-c" width="150" height="150"></canvas>

        <div id="chat-ui">
            <div id="chat-msgs"></div>
            <input id="chat-in" placeholder="Napisz wiadomo≈õƒá... (Enter)">
        </div>
    </div>

    <canvas id="cvs"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    
    <script>
        const EMOTES = ['üëç', 'üëé', 'üòÇ', 'ü§¨'];

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        const app = {
            sock: null, input: {x:0, y:0, d:false, s:false}, myId: null, state: {}, cam: {x:0, y:0, z:1.0}, mapSize: 3000, perks: {}, winScore: 1000,
            floats: [], parts: [], walls: [], bushes: [], healSpots: [], localData: { kills: 0, wins: 0, nick: '' },
            frames: 0, lastPing: 0,
            
            init() {
                this.loadData();
                this.cvs = document.getElementById('cvs'); this.ctx = this.cvs.getContext('2d');
                this.mmCvs = document.getElementById('minimap-c'); this.mmCtx = this.mmCvs.getContext('2d');
                window.addEventListener('resize', ()=>this.resize()); this.resize();
                this.setupInput(); 
                setInterval(() => {
                     document.getElementById('perf').innerText = `FPS: ${this.frames} | PING: ${Date.now() - this.lastPing}ms`;
                     this.frames = 0; 
                     if(this.sock) { this.lastPing = Date.now(); this.sock.emit('ping', () => {}); }
                }, 1000);
                this.loop();
            },
            
            loadData() {
                const d = localStorage.getItem('neon_kpn_data');
                if(d) {
                    this.localData = JSON.parse(d);
                    document.getElementById('nick').value = this.localData.nick || '';
                    document.getElementById('stats-prev').innerText = `Total Kills: ${this.localData.kills} | Wins: ${this.localData.wins}`;
                }
            },
            
            saveData() {
                this.localData.nick = document.getElementById('nick').value;
                localStorage.setItem('neon_kpn_data', JSON.stringify(this.localData));
            },

            resize() {
                this.cvs.width = window.innerWidth * window.devicePixelRatio; this.cvs.height = window.innerHeight * window.devicePixelRatio;
                this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            },
            connect() {
                this.saveData();
                this.sock = io();
                this.sock.on('roomList', list => {
                    const el = document.getElementById('rooms'); el.innerHTML = '';
                    list.forEach(r => el.innerHTML += `<div class="room-item" onclick="app.join('${r.id}', ${r.locked})"><span class="font-bold">${r.name} ${r.locked?'üîí':''}</span><span class="text-xs bg-white/10 px-2 rounded py-1">${r.mode.toUpperCase()} [${r.c}/${r.max}]</span></div>`);
                    this.screen('s-list');
                });
                this.sock.on('roomCreated', id => this.join(id, false));
                this.sock.on('joined', d => {
                    this.myId = d.id; this.mapSize = d.w; this.perks = d.perks; this.winScore = d.winScore;
                    this.walls = d.walls || []; this.bushes = d.bushes || []; this.healSpots = d.healSpots || [];
                    this.screen('s-lobby'); if(d.host) { document.getElementById('host-ctrl').classList.remove('hidden'); document.getElementById('wait-msg').classList.add('hidden'); }
                });
                this.sock.on('gameStart', () => this.screen('hud'));
                this.sock.on('gameOver', d => {
                    if(d.w === this.state.p.find(x=>x.id===this.myId)?.n) { this.localData.wins++; this.saveData(); }
                    let msg = `ZWYCIƒòZCA: ${d.w.toUpperCase()}`;
                    if (d.reason === 'score') msg += " (LIMIT PKT)";
                    const t = document.createElement('div'); t.className=`toast text-white bg-green-600 px-6 py-4 rounded text-xl shadow-lg`; t.innerText=msg; document.getElementById('toasts').appendChild(t); 
                    setTimeout(() => { t.remove(); this.screen('s-lobby'); }, 5000);
                });
                this.sock.on('u', p => {
                    this.state = p;
                    const me = p.p.find(x => x.id === this.myId);
                    
                    const lobbyList = document.getElementById('lobby-player-list');
                    if(lobbyList && document.getElementById('s-lobby').classList.contains('active')) {
                        document.getElementById('roster-header').innerText = `GRACZE W POKOJU (${p.p.length}/25):`;
                        lobbyList.innerHTML = p.p.map(pl => `
                            <div class="flex justify-between items-center text-xs p-1 ${pl.id === this.myId ? 'text-yellow-400 bg-white/10' : 'text-gray-300'}">
                                <span>${pl.n}</span>
                                <span class="uppercase font-bold" style="color:${pl.t==='rock'?'#ef4444':(pl.t==='paper'?'#3b82f6':'#22c55e')}">${pl.t}</span>
                            </div>
                        `).join('');
                    }

                    const lb = document.getElementById('leaderboard-list');
                    lb.innerHTML = p.p.filter(x => x.a).sort((a,b)=>b.score-a.score).slice(0,5).map(pl=>`
                        <div class="flex justify-between ${pl.id===this.myId?'text-yellow-400 font-bold':''}">
                            <span class="w-1/2 truncate">${pl.n}</span>
                            <span class="w-1/4 text-right">${pl.score}</span>
                            <span class="w-1/4 text-right text-yellow-500">${pl.rw || 0}</span>
                        </div>
                    `).join('');

                    if(me) {
                        this.cam.x += (me.x - this.cam.x) * 0.1; this.cam.y += (me.y - this.cam.y) * 0.1;
                        if(me.a) {
                            document.getElementById('bar-hp').style.width = (me.hp/me.mhp)*100 + '%';
                            document.getElementById('bar-xp').style.width = (me.xp/me.nxp)*100 + '%';
                            document.getElementById('score-disp').innerText = me.score + " / " + this.winScore;
                            document.getElementById('kda-disp').innerText = `${me.kills} / ${me.deaths}`;
                            document.getElementById('xp-text').innerText = `${me.xp} / ${me.nxp} XP`;
                            if(me.pen) this.showPerks(); else document.getElementById('perk-ui').style.display = 'none';
                            
                            // UPDATE COOLDOWNS
                            const updateCD = (val, max, elId, fillId) => {
                                const el = document.getElementById(elId);
                                const fill = document.getElementById(fillId);
                                if(val <= 0) { el.classList.add('ready'); el.style.borderColor = '#0f0'; if(fill) fill.style.height='0%'; }
                                else { el.classList.remove('ready'); el.style.borderColor = '#666'; if(fill) fill.style.height = ((val/max)*100)+'%'; }
                            };
                            
                            updateCD(me.dcd, 60, 'cd-dash-pc', 'fill-dash');
                            updateCD(me.scd, me.mscd, 'cd-skill-pc', 'fill-skill');
                            
                            updateCD(me.dcd, 60, 'btn-dash-m', null);
                            updateCD(me.scd, me.mscd, 'btn-skill-m', null);
                        }
                    }
                    if(p.st.sz < this.mapSize) {
                         const warn = document.getElementById('warn-sing');
                         warn.innerText = "BURZA NADCHODZI!";
                         warn.classList.remove('hidden');
                    }
                });
                this.sock.on('fx', d => {
                    if(d.t === 'kill') { 
                        this.toast(d.msg); 
                        if(d.msg.includes(this.localData.nick)) { this.localData.kills++; this.saveData(); }
                    }
                    if(d.t === 'dmg') this.floats.push({x:d.x, y:d.y, t:d.v, c:d.c, l:1.0});
                    if(d.t === 'emote') this.floats.push({x:this.state.p.find(x=>x.id===d.id)?.x, y:this.state.p.find(x=>x.id===d.id)?.y, t:EMOTES[d.e], c:'#fff', l:2.0, font:40});
                    if(d.t === 'part') {
                        for(let i=0; i<d.n; i++) {
                            this.parts.push({
                                x: d.x, y: d.y, 
                                dx: (Math.random()-0.5)*10, dy: (Math.random()-0.5)*10, 
                                c: d.c, l: 30 + Math.random()*20, s: Math.random()*4+2
                            });
                        }
                    }
                });
                
                this.sock.on('chatMsg', d => {
                    const c = document.getElementById('chat-msgs');
                    c.innerHTML += `<div class="mb-1"><span class="font-bold text-cyan-400">${d.n}:</span> ${d.m}</div>`;
                    c.scrollTop = c.scrollHeight;
                });
                
                // Zamiast autojoin, pobieramy listƒô pokoi
                this.sock.emit('getRooms');
            },
            join(id, locked) { const pass = locked ? prompt("Has≈Ço:") : ""; this.sock.emit('join', { roomId: id, nick: document.getElementById('nick').value, pass }); },
            createRoom() { const n = document.getElementById('c-name').value; const p = document.getElementById('c-pass').value; const m = document.getElementById('c-mode').value; if(n) this.sock.emit('createRoom', { name:n, pass:p, mode:m }); },
            screen(id) { document.querySelectorAll('.ui-screen').forEach(e=>e.classList.remove('active')); const el=document.getElementById(id); if(el)el.classList.add('active'); const h=document.getElementById('hud'); if(id==='hud')h.style.display='block'; else h.style.display='none'; },
            setType(t) { document.querySelectorAll('.class-card').forEach(e=>e.classList.remove('sel')); document.getElementById('c-'+t).classList.add('sel'); this.sock.emit('setType', t); },
            start() { this.sock.emit('hostStart'); },
            showPerks() {
                const l = document.getElementById('perk-list'); l.innerHTML = '';
                for(let k in this.perks) l.innerHTML += `<div class="perk-opt glass" onclick="app.pickPerk('${k}')"><div class="font-bold text-cyan-300 text-xl">${this.perks[k].n}</div><div class="text-xs text-gray-400 mt-2">${this.perks[k].d}</div></div>`;
            },
            pickPerk(pid) { this.sock.emit('perk', pid); document.getElementById('perk-ui').style.display='none'; },
            toast(msg) { const t = document.createElement('div'); t.className='toast text-white bg-red-600 px-4 py-2 rounded'; t.innerText=msg; document.getElementById('toasts').appendChild(t); setTimeout(()=>t.remove(), 3000); },
            setupInput() {
                window.onkeydown = e => { 
                    if(document.activeElement === document.getElementById('chat-in')) {
                        if(e.key === 'Enter') { 
                            const txt = e.target.value; 
                            if(txt) this.sock.emit('chat', txt); 
                            e.target.value = ''; document.getElementById('chat-in').style.display = 'none'; 
                        }
                        return;
                    }
                    if(e.key==='w')this.input.y=-1; if(e.key==='s')this.input.y=1; if(e.key==='a')this.input.x=-1; if(e.key==='d')this.input.x=1; if(e.code==='Space')this.input.d=true; if(e.key==='e')this.input.s=true; 
                    if(['1','2','3','4'].includes(e.key)) this.sock.emit('emote', parseInt(e.key)-1);
                    if(e.key === 'Enter') { 
                         const cin = document.getElementById('chat-in'); 
                         cin.style.display = 'block'; cin.focus(); 
                    }
                };
                window.onkeyup = e => { if(e.key==='w'||e.key==='s')this.input.y=0; if(e.key==='a'||e.key==='d')this.input.x=0; if(e.code==='Space')this.input.d=false; if(e.key==='e')this.input.s=false; };
                const mgr = nipplejs.create({ zone: document.getElementById('touch-l'), mode: 'static', position: {left: '50%', top: '50%'}, color: 'white' });
                mgr.on('move', (e, d) => { if(d.vector) { this.input.x = d.vector.x; this.input.y = -d.vector.y; } });
                mgr.on('end', () => { this.input.x = 0; this.input.y = 0; });
            },
            loop() { requestAnimationFrame(()=>this.loop()); if(this.sock) this.sock.emit('input', this.input); if(this.state.p && this.state.p.find(p=>p.id===this.myId && p.pen)) this.showPerks(); this.render(); this.frames++; },
            render() {
                // FIX: Move 'ms' declaration to the top to prevent ReferenceError
                const ms = 150/3000;
                
                // Ensure Alpha is reset to prevent invisible units
                this.ctx.globalAlpha = 1;
                
                const w = window.innerWidth, h = window.innerHeight; this.ctx.fillStyle = '#0a0a12'; this.ctx.fillRect(0,0,w,h);
                if(!this.state || !this.state.p) return;
                this.ctx.save(); this.ctx.translate(w/2, h/2); this.ctx.scale(this.cam.z, this.cam.z); this.ctx.translate(-this.cam.x, -this.cam.y);
                
                // --- CLIP MAP AREA (CIRCLE) ---
                this.ctx.save();
                this.ctx.beginPath(); this.ctx.arc(1500, 1500, 1500, 0, Math.PI*2); 
                this.ctx.clip(); 

                // Grid with Pulse
                const pulse = Math.sin(Date.now() / 1000) * 0.1 + 0.9;
                this.ctx.strokeStyle = `rgba(26, 26, 46, ${pulse})`; this.ctx.lineWidth = 2; this.ctx.beginPath();
                for(let i=0; i<=3000; i+=250) { this.ctx.moveTo(i,0); this.ctx.lineTo(i,3000); this.ctx.moveTo(0,i); this.ctx.lineTo(3000,i); } this.ctx.stroke();
                
                const zr = this.state.st.sz;
                if(zr < 1500) { 
                    this.ctx.beginPath(); this.ctx.arc(1500, 1500, 1500, 0, Math.PI*2); this.ctx.arc(1500, 1500, zr, 0, Math.PI*2, true); 
                    this.ctx.fillStyle = 'rgba(255, 0, 0, 0.2)'; this.ctx.fill(); 
                    
                    // Storm Pulse
                    this.ctx.beginPath(); this.ctx.arc(1500, 1500, zr, 0, Math.PI*2); 
                    this.ctx.strokeStyle = `rgba(255, 0, 0, ${pulse})`; this.ctx.lineWidth = 5 + pulse * 5; this.ctx.stroke(); 
                }
                
                this.bushes.forEach(b => { this.ctx.fillStyle = '#004d00'; this.ctx.beginPath(); this.ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); this.ctx.fill(); this.ctx.strokeStyle = '#006600'; this.ctx.lineWidth=5; this.ctx.stroke(); });

                this.healSpots.forEach(h => {
                    this.ctx.fillStyle = `rgba(0, 255, 0, 0.2)`;
                    this.ctx.beginPath(); this.ctx.arc(h.x, h.y, h.r + Math.sin(Date.now()/500)*5, 0, Math.PI*2); this.ctx.fill();
                    this.ctx.fillStyle = '#0f0'; this.ctx.font = '30px Arial'; this.ctx.fillText('+', h.x-10, h.y+10);
                });

                if(this.state.z) this.state.z.forEach(z => { this.ctx.fillStyle = z.t==='rock'?'#f00':(z.t==='paper'?'#00f':'#0f0'); this.ctx.globalAlpha=0.1; this.ctx.beginPath(); this.ctx.arc(z.x*ms, z.y*ms, 150*ms, 0, Math.PI*2); this.ctx.fill(); this.ctx.globalAlpha=1; });
                this.state.o.forEach(o => { this.ctx.fillStyle='#ffd700'; this.ctx.shadowColor='#ffd700'; this.ctx.shadowBlur=10; this.ctx.beginPath(); this.ctx.arc(o[0],o[1],5,0,Math.PI*2); this.ctx.fill(); this.ctx.shadowBlur=0; });

                this.ctx.fillStyle = '#222'; this.ctx.strokeStyle = '#0ff'; this.ctx.lineWidth = 3;
                this.walls.forEach(wa => { this.ctx.shadowBlur = 15; this.ctx.shadowColor = '#0ff'; this.ctx.fillRect(wa.x, wa.y, wa.w, wa.h); this.ctx.strokeRect(wa.x, wa.y, wa.w, wa.h); this.ctx.shadowBlur = 0; });

                this.ctx.restore(); // End Clip (Camera transform still active)
                this.ctx.beginPath(); this.ctx.arc(1500, 1500, 1500, 0, Math.PI*2); this.ctx.strokeStyle = '#444'; this.ctx.lineWidth = 10; this.ctx.stroke();

                const drawUnit = (x,y,t,r,inv,my,invuln) => {
                    // Reset Alpha at start of unit draw
                    this.ctx.globalAlpha = 1;
                    
                    const c = t==='rock'?'#ef4444':(t==='paper'?'#3b82f6':(t==='zombie'?'#777':'#22c55e'));
                    this.ctx.fillStyle=c; 
                    
                    if(inv) this.ctx.globalAlpha = my ? 0.5 : 0; 
                    if(invuln) this.ctx.globalAlpha = (Date.now()%200 < 100) ? 0.5 : 1; 

                    if(t === 'zombie') {
                        // GLITCH EFFECT RENDER
                        this.ctx.save();
                        this.ctx.translate(x, y);
                        const jitX = (Math.random()-0.5) * 4;
                        const jitY = (Math.random()-0.5) * 4;
                        this.ctx.fillStyle = '#00ff00'; this.ctx.fillRect(-15+jitX, -15, 30, 30);
                        this.ctx.fillStyle = '#ff00ff'; this.ctx.fillRect(-15-jitX, -15, 30, 30);
                        this.ctx.fillStyle = '#fff'; this.ctx.fillRect(-15, -15, 30, 30);
                        this.ctx.restore();
                    } else {
                        // PLAYER GLOW
                        this.ctx.shadowBlur = 10; this.ctx.shadowColor = c;
                        this.ctx.beginPath(); this.ctx.arc(x,y,r,0,Math.PI*2); this.ctx.fill(); 
                        this.ctx.shadowBlur = 0;
                        this.ctx.fillStyle='#fff'; this.ctx.font=`${r}px Arial`; this.ctx.textAlign='center'; this.ctx.textBaseline='middle'; this.ctx.fillText(t==='rock'?'ü™®':(t==='paper'?'üìÑ':(t==='zombie'?'':'‚úÇÔ∏è')),x,y);
                    }
                    this.ctx.globalAlpha = 1; 
                };
                
                // Particles
                this.parts = this.parts.filter(p => {
                    p.x += p.dx; p.y += p.dy; p.l--;
                    this.ctx.fillStyle = p.c; this.ctx.fillRect(p.x, p.y, p.s, p.s);
                    return p.l > 0;
                });

                this.state.m.forEach(m => drawUnit(m.x, m.y, m.t, 18, false, false, false));
                this.state.p.forEach(p => { 
                    if(!p.a || (p.inv && p.id !== this.myId)) return; 
                    if(p.inBush) this.ctx.globalAlpha = 0.6;
                    drawUnit(p.x,p.y,p.t,28, p.inv, p.id===this.myId, p.invuln); 
                    this.ctx.globalAlpha = 1;
                    this.ctx.fillStyle='#fff'; this.ctx.font='10px Arial'; this.ctx.fillText(p.n,p.x,p.y-40); 
                    this.ctx.fillStyle='#333'; this.ctx.fillRect(p.x-20,p.y-35,40,4); this.ctx.fillStyle='#0f0'; this.ctx.fillRect(p.x-20,p.y-35,40*(p.hp/p.mhp),4); 
                });
                
                this.floats = this.floats.filter(f => {
                    f.y -= 1; f.l -= 0.02;
                    this.ctx.globalAlpha = Math.max(0, f.l);
                    this.ctx.fillStyle = f.c; this.ctx.font = `bold ${f.font||20}px Arial`; 
                    this.ctx.fillText(f.t, f.x, f.y);
                    this.ctx.globalAlpha = 1;
                    return f.l > 0;
                });
                
                this.ctx.restore(); // Restore camera transform

                // Minimap
                this.mmCtx.clearRect(0,0,150,150); 
                this.mmCtx.fillStyle='#111'; this.mmCtx.beginPath(); this.mmCtx.arc(75, 75, 75, 0, Math.PI*2); this.mmCtx.fill(); // Map BG
                
                this.mmCtx.fillStyle = '#444'; this.walls.forEach(w => this.mmCtx.fillRect(w.x*ms, w.y*ms, w.w*ms, w.h*ms));
                
                // --- FIX: Add Bushes & Heal Spots to Minimap ---
                this.mmCtx.fillStyle = '#004d00'; 
                this.bushes.forEach(b => { this.mmCtx.beginPath(); this.mmCtx.arc(b.x*ms, b.y*ms, b.r*ms, 0, Math.PI*2); this.mmCtx.fill(); });
                
                this.mmCtx.fillStyle = '#0f0';
                this.healSpots.forEach(h => { this.mmCtx.beginPath(); this.mmCtx.arc(h.x*ms, h.y*ms, h.r*ms, 0, Math.PI*2); this.mmCtx.fill(); });
                // -----------------------------------------------

                if(zr < 1500) { this.mmCtx.strokeStyle = '#f00'; this.mmCtx.beginPath(); this.mmCtx.arc(75, 75, zr*ms, 0, Math.PI*2); this.mmCtx.stroke(); }
                if(this.state.z) this.state.z.forEach(z => { this.mmCtx.strokeStyle = z.t==='rock'?'#f00':(z.t==='paper'?'#00f':'#0f0'); this.mmCtx.beginPath(); this.mmCtx.arc(z.x*ms, z.y*ms, 150*ms, 0, Math.PI*2); this.mmCtx.stroke(); });
                if(this.state.p) this.state.p.forEach(p => { if(p.a && (!p.inv || p.id===this.myId)) { this.mmCtx.fillStyle = p.id===this.myId?'#fff':'#f00'; this.mmCtx.beginPath(); this.mmCtx.arc(p.x*ms, p.y*ms, 2, 0, Math.PI*2); this.mmCtx.fill(); }});
            }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>
